

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Tutorial (multiclass) &mdash; detectree2 1.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=aec50437"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Running Jupyter Notebook and Installing Detectree2 on a HPC platform (like CSD3)" href="cluster.html" />
    <link rel="prev" title="2. Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            detectree2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Tutorial (multiclass)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#preparing-data">3.1. Preparing data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-models">3.2. Training models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#landscape-predictions">3.3. Landscape predictions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cluster.html">4. Running Jupyter Notebook and Installing Detectree2 on a HPC platform (like CSD3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">5. Contributing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-git.html">6. Git/Github</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">detectree2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>Tutorial (multiclass)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial_multi.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial-multiclass">
<h1><span class="section-number">3. </span>Tutorial (multiclass)<a class="headerlink" href="#tutorial-multiclass" title="Link to this heading"></a></h1>
<p>This tutorial goes through the steps of multiclass detection and
delineation (e.g. species mapping, disease mapping). A guide to single
class prediction is available
<a class="reference external" href="https://patball1.github.io/detectree2/tutorial.html">here</a> - this covers
more detail on the fundamentals of training and should be reviewed before this
tutorial. The multiclassprocess is slightly more intricate than single class
prediction as the classes need to be correctly encoded and caried throughout the pipeline.</p>
<p>The key steps are:</p>
<ol class="arabic simple">
<li><p>Preparing data</p></li>
<li><p>Training models</p></li>
<li><p>Evaluating model performance</p></li>
<li><p>Making landscape level predictions</p></li>
</ol>
<section id="preparing-data">
<h2><span class="section-number">3.1. </span>Preparing data<a class="headerlink" href="#preparing-data" title="Link to this heading"></a></h2>
<p>Data can be prepared in a similar way to the single class case but the classes
and their order (mapping) need to be saved so that they can be accessed
consistently across training and prediction. The classes are saved in a json
file with the class names and their indices. The indices are used to encode
the classes in the training.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="c1"># Load the data</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/SHARED/detectree2&quot;</span>

<span class="n">site_path</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/Danum_lianas&quot;</span>

<span class="c1"># Set the path to the orthomosaic and the crown shapefile</span>
<span class="n">img_path</span> <span class="o">=</span> <span class="n">site_path</span> <span class="o">+</span> <span class="s2">&quot;/rgb/2017_50ha_Ortho_reproject.tif&quot;</span>
<span class="n">crown_path</span> <span class="o">=</span> <span class="n">site_path</span> <span class="o">+</span> <span class="s2">&quot;/crowns/Danum_lianas_full2017.gpkg&quot;</span>

<span class="c1"># Here, we set the name of the output folder.</span>
<span class="c1"># Set tiling parameters</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">tile_width</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">tile_height</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">appends</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_width</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>

<span class="n">out_dir</span> <span class="o">=</span> <span class="n">site_path</span> <span class="o">+</span> <span class="s2">&quot;/tilesClass_&quot;</span> <span class="o">+</span> <span class="n">appends</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

<span class="c1"># Read in the tiff file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

<span class="c1"># Read in crowns (then filter by an attribute?)</span>
<span class="n">crowns</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crown_path</span><span class="p">)</span>
<span class="n">crowns</span> <span class="o">=</span> <span class="n">crowns</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crowns</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">class_column</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>

<span class="c1"># Record the classes and save the class mapping</span>
<span class="n">record_classes</span><span class="p">(</span>
    <span class="n">crowns</span><span class="o">=</span><span class="n">crowns</span><span class="p">,</span>  <span class="c1"># Geopandas dataframe with crowns</span>
    <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>  <span class="c1"># Output directory to save class mapping</span>
    <span class="n">column</span><span class="o">=</span><span class="n">class_column</span><span class="p">,</span>  <span class="c1"># Column to be used for classes</span>
    <span class="n">save_format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span>  <span class="c1"># Choose between &#39;json&#39; or &#39;pickle&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The class mapping has been saved in the output directory as a json file called
<code class="docutils literal notranslate"><span class="pre">class_to_idx.json</span></code>. This file can now be accessed to encode the classes in
training and prediction steps.</p>
<p>To tile the data, we call the <code class="docutils literal notranslate"><span class="pre">tile_data</span></code> function as we did in the single
class case except now we point to the column name of the classes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tile the data</span>
<span class="n">tile_data</span><span class="p">(</span>
    <span class="n">img_path</span><span class="o">=</span><span class="n">img_path</span><span class="p">,</span>  <span class="c1"># Path to the orthomosaic</span>
    <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>  <span class="c1"># Output directory to save tiles</span>
    <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>  <span class="c1"># Buffer around the crowns</span>
    <span class="n">tile_width</span><span class="o">=</span><span class="n">tile_width</span><span class="p">,</span>  <span class="c1"># Width of the tiles</span>
    <span class="n">tile_height</span><span class="o">=</span><span class="n">tile_height</span><span class="p">,</span>  <span class="c1"># Height of the tiles</span>
    <span class="n">crowns</span><span class="o">=</span><span class="n">crowns</span><span class="p">,</span>  <span class="c1"># Geopandas dataframe with crowns</span>
    <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>  <span class="c1"># Threshold for the buffer</span>
    <span class="n">class_column</span><span class="o">=</span><span class="n">class_column</span><span class="p">,</span>  <span class="c1"># Column to be used for classes</span>
<span class="p">)</span>

<span class="c1"># Split the data into training and validation sets</span>
<span class="n">to_traintest_folders</span><span class="p">(</span>
    <span class="n">tiles_folder</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>  <span class="c1"># Directory where tiles are saved</span>
    <span class="n">out_folder</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>  <span class="c1"># Final directory for train/test data</span>
    <span class="n">test_frac</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Fraction of data to be used for testing</span>
    <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># Number of folds (optional, can be set to 1 for no fold splitting)</span>
    <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Ensure no overlap between train/test tiles</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>  <span class="c1"># Set seed for reproducibility</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="training-models">
<h2><span class="section-number">3.2. </span>Training models<a class="headerlink" href="#training-models" title="Link to this heading"></a></h2>
<p>To train with multiple classes, we need to ensure that the classes are
registered correctly in the dataset catalogue. This can be done with the class
mapping file that was saved in the previous step. The class mapping file will
set the classes and their indices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectree2.models.train</span> <span class="kn">import</span> <span class="n">register_train_data</span><span class="p">,</span> <span class="n">remove_registered_data</span><span class="p">,</span> <span class="n">setup_cfg</span><span class="p">,</span> <span class="n">MyTrainer</span>
<span class="kn">from</span> <span class="nn">detectree2.preprocessing.tiling</span> <span class="kn">import</span> <span class="n">load_class_mapping</span>

<span class="c1"># Set validation fold</span>
<span class="n">val_fold</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">site_path</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/Danum_lianas&quot;</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">site_path</span> <span class="o">+</span> <span class="s2">&quot;/tilesClass_40_30_0.6/train&quot;</span>
<span class="n">class_mapping_file</span> <span class="o">=</span>  <span class="n">site_path</span> <span class="o">+</span> <span class="s2">&quot;/tilesClass_40_30_0.6/&quot;</span> <span class="o">+</span> <span class="s2">&quot;/class_to_idx.json&quot;</span>
<span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;DanumLiana&quot;</span>

<span class="n">register_train_data</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">val_fold</span><span class="o">=</span><span class="n">val_fold</span><span class="p">,</span> <span class="n">class_mapping_file</span><span class="o">=</span><span class="n">class_mapping_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Now the data is registered, should generate the configuration (<cite>cfg</cite>) and train
the model. By passing the class mapping file to the configuration set up, the
<cite>cfg</cite> will be register the number of classes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectron2.modeling</span> <span class="kn">import</span> <span class="n">build_model</span>
<span class="kn">from</span> <span class="nn">detectron2.modeling.roi_heads.fast_rcnn</span> <span class="kn">import</span> <span class="n">FastRCNNOutputLayers</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>


<span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">today</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_name</span><span class="p">,]</span>

<span class="n">trains</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_train&quot;</span><span class="p">,)</span>
<span class="n">tests</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_val&quot;</span><span class="p">,)</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/WORK/detectree2/models/&quot;</span> <span class="o">+</span> <span class="n">today</span> <span class="o">+</span> <span class="s2">&quot;_Danum_lianas&quot;</span>

<span class="n">base_model</span> <span class="o">=</span> <span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_101_FPN_3x.yaml&quot;</span>  <span class="c1"># Path to the model config</span>

<span class="c1"># When you increase the number of channels (i.e., the number of filters) in a Convolutional Neural Network (CNN), the general recommendation is to decrease the learning rate</span>
<span class="n">lrs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.00003</span><span class="p">]</span>

<span class="c1"># Set up model configuration, using the class mapping to determine the number of classes</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">setup_cfg</span><span class="p">(</span>
    <span class="n">base_model</span><span class="o">=</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_101_FPN_3x.yaml&quot;</span><span class="p">,</span>
    <span class="n">trains</span><span class="o">=</span><span class="n">trains</span><span class="p">,</span>
    <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">500000</span><span class="p">,</span>
    <span class="n">eval_period</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">base_lr</span><span class="o">=</span><span class="n">lrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
    <span class="n">resize</span><span class="o">=</span><span class="s2">&quot;rand_fixed&quot;</span><span class="p">,</span>
    <span class="n">class_mapping_file</span><span class="o">=</span><span class="n">class_mapping_file</span>  <span class="c1"># Optional</span>
<span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">MyTrainer</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">resume_or_load</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="landscape-predictions">
<h2><span class="section-number">3.3. </span>Landscape predictions<a class="headerlink" href="#landscape-predictions" title="Link to this heading"></a></h2>
<p>COMING SOON</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial.html" class="btn btn-neutral float-left" title="2. Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cluster.html" class="btn btn-neutral float-right" title="4. Running Jupyter Notebook and Installing Detectree2 on a HPC platform (like CSD3)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, James Ball.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>