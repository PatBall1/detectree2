

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5. Contributing guide &mdash; detectree2 1.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=aec50437"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Git/Github" href="using-git.html" />
    <link rel="prev" title="4. Running in Jupyter Notebook on a HPC platform" href="cluster.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            detectree2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_multi.html">3. Tutorial (multiclass)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cluster.html">4. Running in Jupyter Notebook on a HPC platform</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Contributing guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#contributing-to-detectree2">5.1. Contributing to Detectree2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#code-of-conduct">5.1.1. Code of Conduct</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started-issues">5.1.2. Getting Started - Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filing-a-bug-report">5.1.3. Filing a bug report</a></li>
<li class="toctree-l3"><a class="reference internal" href="#detectree2-github-tips">5.1.4. Detectree2 Github tips</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tips-for-creating-a-detectree2-pr">5.1.5. Tips for creating a detectree2 PR</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-github-s-ui-to-commit-pr">5.1.5.1. Using GitHub’s UI to commit PR</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-command-line-to-rebase">5.1.5.2. Using command line to rebase</a></li>
<li class="toctree-l4"><a class="reference internal" href="#general-tips">5.1.5.3. General tips</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detectree2-setup-for-developers">5.2. Detectree2 setup for developers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-development-environment">5.2.1. Setting up development environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#programming-style">5.2.2. Programming style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pre-commit-hooks">5.2.2.1. Pre-commit hooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#linting">5.2.3. Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docstrings">5.2.4. Docstrings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#autoformatters">5.2.5. Autoformatters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#yapf">5.2.5.1. YAPF</a></li>
<li class="toctree-l4"><a class="reference internal" href="#black">5.2.5.2. Black</a></li>
<li class="toctree-l4"><a class="reference internal" href="#autopep8">5.2.5.3. Autopep8</a></li>
<li class="toctree-l4"><a class="reference internal" href="#formatting-aside">5.2.5.4. Formatting aside</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#static-typing">5.2.6. Static typing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#continuous-integration">5.3. Continuous integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatic-documentation">5.4. Automatic Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tests">5.5. Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-detectree2">5.6. Building Detectree2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gdal-complexities">5.6.1. GDAL complexities</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-pip">5.6.2. Using pip</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fixing-detectron2-version">5.6.2.1. Fixing detectron2 version</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-detectree2-using-conda">5.6.3. Building Detectree2 using Conda</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distributing-detectree2-using-conda">5.6.4. Distributing detectree2 using Conda</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#python-development-environment">5.7. Python development environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using-git.html">6. Git/Github</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">7. API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">detectree2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">5. </span>Contributing guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/contributing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="contributing-guide">
<h1><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">5. </span>Contributing guide</a><a class="headerlink" href="#contributing-guide" title="Link to this heading"></a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#contributing-guide" id="id19">Contributing guide</a></p>
<ul>
<li><p><a class="reference internal" href="#contributing-to-detectree2" id="id20">Contributing to Detectree2</a></p>
<ul>
<li><p><a class="reference internal" href="#code-of-conduct" id="id21">Code of Conduct</a></p></li>
<li><p><a class="reference internal" href="#getting-started-issues" id="id22">Getting Started - Issues</a></p></li>
<li><p><a class="reference internal" href="#filing-a-bug-report" id="id23">Filing a bug report</a></p></li>
<li><p><a class="reference internal" href="#detectree2-github-tips" id="id24">Detectree2 Github tips</a></p></li>
<li><p><a class="reference internal" href="#tips-for-creating-a-detectree2-pr" id="id25">Tips for creating a detectree2 PR</a></p>
<ul>
<li><p><a class="reference internal" href="#using-github-s-ui-to-commit-pr" id="id26">Using GitHub’s UI to commit PR</a></p></li>
<li><p><a class="reference internal" href="#using-command-line-to-rebase" id="id27">Using command line to rebase</a></p></li>
<li><p><a class="reference internal" href="#general-tips" id="id28">General tips</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#detectree2-setup-for-developers" id="id29">Detectree2 setup for developers</a></p>
<ul>
<li><p><a class="reference internal" href="#setting-up-development-environment" id="id30">Setting up development environment</a></p></li>
<li><p><a class="reference internal" href="#programming-style" id="id31">Programming style</a></p>
<ul>
<li><p><a class="reference internal" href="#pre-commit-hooks" id="id32">Pre-commit hooks</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#linting" id="id33">Linting</a></p></li>
<li><p><a class="reference internal" href="#docstrings" id="id34">Docstrings</a></p></li>
<li><p><a class="reference internal" href="#autoformatters" id="id35">Autoformatters</a></p>
<ul>
<li><p><a class="reference internal" href="#yapf" id="id36">YAPF</a></p></li>
<li><p><a class="reference internal" href="#black" id="id37">Black</a></p></li>
<li><p><a class="reference internal" href="#autopep8" id="id38">Autopep8</a></p></li>
<li><p><a class="reference internal" href="#formatting-aside" id="id39">Formatting aside</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#static-typing" id="id40">Static typing</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#continuous-integration" id="id41">Continuous integration</a></p></li>
<li><p><a class="reference internal" href="#automatic-documentation" id="id42">Automatic Documentation</a></p></li>
<li><p><a class="reference internal" href="#tests" id="id43">Tests</a></p></li>
<li><p><a class="reference internal" href="#building-detectree2" id="id44">Building Detectree2</a></p>
<ul>
<li><p><a class="reference internal" href="#gdal-complexities" id="id45">GDAL complexities</a></p></li>
<li><p><a class="reference internal" href="#using-pip" id="id46">Using pip</a></p>
<ul>
<li><p><a class="reference internal" href="#fixing-detectron2-version" id="id47">Fixing detectron2 version</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#building-detectree2-using-conda" id="id48">Building Detectree2 using Conda</a></p></li>
<li><p><a class="reference internal" href="#distributing-detectree2-using-conda" id="id49">Distributing detectree2 using Conda</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#python-development-environment" id="id50">Python development environment</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="contributing-to-detectree2">
<h2><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">5.1. </span>Contributing to Detectree2</a><a class="headerlink" href="#contributing-to-detectree2" title="Link to this heading"></a></h2>
<p>Thanks for taking the time to contribute to detectree2!</p>
<section id="code-of-conduct">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">5.1.1. </span>Code of Conduct</a><a class="headerlink" href="#code-of-conduct" title="Link to this heading"></a></h3>
<p>All contributors are expected to abide by the <a class="reference external" href="https://github.com/PatBall1/detectree2/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a></p>
</section>
<section id="getting-started-issues">
<h3><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">5.1.2. </span>Getting Started - Issues</a><a class="headerlink" href="#getting-started-issues" title="Link to this heading"></a></h3>
<p>The “to do” task list for detectree2 starts at the <a class="reference external" href="https://github.com/PatBall1/detectree2/issues">Issues</a> page in Github.</p>
<p>Note: Before submitting a new issue, you should search the existing issues to make sure that it hasn’t already been reported.</p>
</section>
<section id="filing-a-bug-report">
<h3><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">5.1.3. </span>Filing a bug report</a><a class="headerlink" href="#filing-a-bug-report" title="Link to this heading"></a></h3>
<p>Bug reports are important in helping identify things that aren’t working in detectree2. Filing a bug report is straightforward: Head to the Issues page, click on the New issue button, and select the Bug Report template to get started.</p>
</section>
<section id="detectree2-github-tips">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">5.1.4. </span>Detectree2 Github tips</a><a class="headerlink" href="#detectree2-github-tips" title="Link to this heading"></a></h3>
<p>There are many excellent resources for learning Git. See <a class="reference internal" href="using-git.html"><span class="doc">Git/Github</span></a>, for a brief overview of Git and Github. For tips relating to detectree2 see <a class="reference internal" href="#detectree2-tips">detectree2 tips</a>.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/JamesFergusson/Introduction-to-Research-Computing/blob/master/05_BestPractice_GIT.md">https://github.com/JamesFergusson/Introduction-to-Research-Computing/blob/master/05_BestPractice_GIT.md</a></p></li>
<li><p><a class="reference external" href="https://www.bristol.ac.uk/acrc/research-software-engineering/training/">https://www.bristol.ac.uk/acrc/research-software-engineering/training/</a></p>
<ul>
<li><p><a class="reference external" href="https://chryswoods.com/introducing_git/">https://chryswoods.com/introducing_git/</a></p></li>
<li><p><a class="reference external" href="https://chryswoods.com/git_collaboration/">https://chryswoods.com/git_collaboration/</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://ohshitgit.com/">https://ohshitgit.com/</a></p></li>
</ul>
</section>
<section id="tips-for-creating-a-detectree2-pr">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">5.1.5. </span>Tips for creating a detectree2 PR</a><a class="headerlink" href="#tips-for-creating-a-detectree2-pr" title="Link to this heading"></a></h3>
<p id="detectree2-tips">This guide assumes that most developers do not have permission to contribute to the repo directly and therefore need to fork the project. For users with privileges to contribute to detectree2 directly the concepts are the same, but a PR can be initiated from a feature branch within the detectree2 project directly.</p>
<p>First consult <a class="reference internal" href="using-git.html"><span class="doc">Git/Github</span></a> or any of the above resources if you are unclear on how to create a good PR. See <a class="reference external" href="https://github.com/PatBall1/detectree2/pull/6#issuecomment-1189473815">issue/6</a> for some recommendatations on best practices when forking a project.</p>
<p>Once a PR has been created, it is good practice to keep the PR’s feature branch up-to-date with <a class="reference external" href="https://github.com/PatBall1/detectree2">upstream</a> master during the PR submission and review process.
This can be done simply with the <code class="docutils literal notranslate"><span class="pre">Sync</span> <span class="pre">fork</span></code> link on github which can synchronise <cite>upstream master</cite> to any remote branch, and then pull the changes using the command line to continue developing locally. This is the simplest way to keep the PR branch updated.</p>
<p>It’s also possible to do all this locally using Git. I.e. In your local clone do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">upstream</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PatBall1</span><span class="o">/</span><span class="n">detectree2</span>
<span class="n">git</span> <span class="n">fetch</span> <span class="n">upstream</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">master</span> <span class="c1"># if not already there</span>
<span class="n">git</span> <span class="n">rebase</span> <span class="n">upstream</span><span class="o">/</span><span class="n">master</span> <span class="c1"># or git merge upstream/master</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">&lt;</span><span class="n">feature</span><span class="o">-</span><span class="n">branch</span><span class="o">&gt;</span>
<span class="n">git</span> <span class="n">rebase</span> <span class="n">master</span> <span class="c1"># or git merge master</span>
<span class="c1"># now push to your remote repo</span>
<span class="n">git</span> <span class="n">push</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">lease</span> <span class="n">origin</span> <span class="o">&lt;</span><span class="n">feature</span><span class="o">-</span><span class="n">branch</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This process can be abbreviated to a couple of commands for advanced Git users. We can modify commits using <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rebase</span> <span class="pre">-i</span></code> (interactive rebase) to clean up the commit history. We can squash commits, remove unnecessary commits or edit commits.</p>
<p>TIP: The process of rebasing on <code class="docutils literal notranslate"><span class="pre">master</span></code> may need to be done multiple times during a PR.</p>
<p>At the end of the PR we can use GitHub’s UI to commit. The available options are explained here: <a class="reference external" href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges">Pull request merges</a>.</p>
<section id="using-github-s-ui-to-commit-pr">
<h4><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">5.1.5.1. </span>Using GitHub’s UI to commit PR</a><a class="headerlink" href="#using-github-s-ui-to-commit-pr" title="Link to this heading"></a></h4>
<p>Whether to squash commits or not is explained well in this article:
<a class="reference external" href="https://blog.mergify.com/what-is-the-difference-between-a-merge-commit-a-squash/">https://blog.mergify.com/what-is-the-difference-between-a-merge-commit-a-squash/</a></p>
<p>The github UI will give the <code class="docutils literal notranslate"><span class="pre">squash</span> <span class="pre">and</span> <span class="pre">merge</span></code> option when committing a PR to master, but one should proceed with caution. It squashes all of the commits down to one commit in the base branch with an option to edit a commit summary (please modify the commit summary from the default one provided with a more concise message of the PR’s contributions). One could argue that this leads to a linear history (i.e. doesn’t contain merges) but often it can result in large commits that are difficult to read, so if following this approach try to ensure that PRs have a single focus. Squashing also loses valuable information from individual commits.</p>
<p>Alternatively, you can select the <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">and</span> <span class="pre">merge</span></code> option - in this case all commits from the head branch are added onto the base branch individually without a merge commit. If you have conflicts and you still wish to rebase and merge, these need to be resolved locally using the command line as described <a class="reference external" href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges">here</a> and the next section. My advice is to ensure that PRs have a single focus and to reduce unnecessary style commits with pre-commit hooks. <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rebase</span> <span class="pre">-i</span></code> is an extremely useful command that every developer should be aware of to neaten history when ready to merge.</p>
<p>Finally, GitHub provides the option to <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">a</span> <span class="pre">merge</span> <span class="pre">commit</span></code> which simply merges branch into main. I would advise against this as it creates complicated git histories that are difficult to read.</p>
<p>For Detectree2, it’s up to you which approach to take. Given that the project is quite small and there are few contributors I’d suggest using pre-commit hooks and interactive rebases to improve commit quality in favour of squashing. Squashing is also generally fine (and the easier approach of the two), but try to avoid doing it all the time.</p>
</section>
<section id="using-command-line-to-rebase">
<h4><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">5.1.5.2. </span>Using command line to rebase</a><a class="headerlink" href="#using-command-line-to-rebase" title="Link to this heading"></a></h4>
<p>If you want to rebase the commits but are unable to <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">and</span> <span class="pre">merge</span></code> automatically on GitHub.com you must:</p>
<blockquote>
<div><ul class="simple">
<li><p>Rebase the PR branch onto master locally on the command line</p></li>
<li><p>Resolve any merge conflicts on the command line</p></li>
<li><p>Force push to the PR branch</p></li>
</ul>
</div></blockquote>
<p>There is plenty of useful information on this online in the <a class="reference external" href="https://git-scm.com/docs/git-rebase">official docs</a> and this <a class="reference external" href="https://stackoverflow.com/questions/7929369/how-to-rebase-local-branch-onto-remote-master">stackoverflow</a> post. This makes the GitHub UI process trivial and one can select <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">and</span> <span class="pre">merge</span></code>. Rebasing is more involved than merging but leads to a linear history.</p>
<p>TIP: If following this approach, make sure to use pre-commit hooks to improve quality of individual commits.</p>
</section>
<section id="general-tips">
<h4><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">5.1.5.3. </span>General tips</a><a class="headerlink" href="#general-tips" title="Link to this heading"></a></h4>
<p>TIP: Try to avoid merging the PR to a <cite>dev</cite> branch. This is considered bad practice since when it comes to merge to master the eventual <cite>PR</cite> can be large and difficult to understand. PRs should have a single focus.</p>
<p>TIP: Delete the branch after merging to master.</p>
<p>TIP: Always nominate a collaborator to review the PR before merging.</p>
<p>TIP: Do not merge unless all tests are passing.</p>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<ul>
<li><p>Many of the recommendations above can be made default in Github’s settings:</p>
<blockquote>
<div><ul class="simple">
<li><p>Prohibit commits direct to master.</p></li>
<li><p>Automatically squash on merge.</p></li>
<li><p>Prevent merge unless all tests are passing.</p></li>
<li><p>Only allow a merge if approved by assigned Reviewers.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">master</span></code> to <code class="docutils literal notranslate"><span class="pre">main</span></code>. GitHub provides a step-by-step walkthrough.</p></li>
</ul>
</div>
</section>
</section>
</section>
<section id="detectree2-setup-for-developers">
<h2><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">5.2. </span>Detectree2 setup for developers</a><a class="headerlink" href="#detectree2-setup-for-developers" title="Link to this heading"></a></h2>
<p>For projects with many contributors it is good practice to adhere to a programming style and testing framework. The programming style is enforced with a combination of pre-commit hooks and CI checks. Settings for detectree2’s programming style components are given in <cite>setup.cfg</cite>, in the project root.</p>
<p>We adopt <cite>GitHub actions</cite> to deploy software development workflows <a class="reference external" href="https://github.com/PatBall1/detectree2/actions">detectree2/actions</a>, workflows are steered automatically using github actions in <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/master/.github/workflows">.github/workflows</a> directory, a good example is: <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/master/.github/workflows/python-app.yml">python-app.yaml</a>.  The code checks are triggered automatically on pushing to a branch. The workflows detail the required dependencies for developing and testing detectree2, and should be consulted if anything in the following section is unclear.</p>
<p>For reference, the relevant <code class="docutils literal notranslate"><span class="pre">detectree2</span></code> subprojects are:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/ma595/detectree2-docker">detectree2-docker GitHub repo</a> For docker containers used in CI.</p></li>
<li><p><a class="reference external" href="https://github.com/ma595/detectree2-data">detectree2-data GitHub repo</a> For example data used in CI.</p></li>
<li><p><a class="reference external" href="https://anaconda.org/ma595/detectree2">anaconda distribution</a> detectree2 conda package.</p></li>
</ul>
</div></blockquote>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Publish model on model_zoo</p></li>
</ul>
</div>
<section id="setting-up-development-environment">
<h3><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">5.2.1. </span>Setting up development environment</a><a class="headerlink" href="#setting-up-development-environment" title="Link to this heading"></a></h3>
<p>Using conda or pip (below we show pip):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">flake8</span> <span class="n">flake8</span><span class="o">-</span><span class="n">docstrings</span> <span class="n">mypy</span> <span class="n">autopep8</span> <span class="n">isort</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="id4">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">dev-environment.yaml</span></code>.</p></li>
</ul>
</div>
</section>
<section id="programming-style">
<h3><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">5.2.2. </span>Programming style</a><a class="headerlink" href="#programming-style" title="Link to this heading"></a></h3>
<p id="id5">Detectree2 currently utilises the following tools to check code style and consistency.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">yapf</span></code>: Autoformatter ensures consistent formatting of Python files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flake8</span></code>: Multiple checks for - linting - syntax errors or anti-patterns - (lack of) executable flags on files - docstring validation - function complexity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mypy</span></code>: Validate Python type hints.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isort</span></code>: Checks that imports are correctly sorted.</p></li>
</ul>
<p>A number of other style choices have been enforced across the project:</p>
<ul class="simple">
<li><p>Line length = 120 characters</p></li>
<li><p>Google style docstrings</p></li>
<li><p>Indent width = 4 spaces per tab.</p></li>
</ul>
<p>This style is enforced both locally (using pre-commit hooks) and remotely (using github workflows). It is possible to use remote checks only, but it is often faster to check locally first than to wait for the github workflow to execute.</p>
<section id="pre-commit-hooks">
<h4><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">5.2.2.1. </span>Pre-commit hooks</a><a class="headerlink" href="#pre-commit-hooks" title="Link to this heading"></a></h4>
<p>Pre-commit hooks ensure that each commit passes a minimum set of style checks. To set up pre-commit hooks do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pre</span><span class="o">-</span><span class="n">commit</span>
<span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">install</span>
<span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">run</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">files</span> <span class="c1"># it is a good idea to do this over all files not just the files that have changed</span>

<span class="c1"># or run on the files that have changed:</span>

<span class="n">git</span> <span class="n">add</span> <span class="o">-</span><span class="n">u</span>  <span class="c1"># e.g</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;your message&quot;</span>
</pre></div>
</div>
<p>If tests do not pass, correct errors and then do <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">-u</span></code> again so that changes are staged.</p>
<p>If it is desirable to avoid pre-commit hooks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;your message&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">verify</span>
</pre></div>
</div>
<p>With checks configured in the <cite>.pre-commit-config.yaml</cite> file in the project root. Note that a commit will not be made unless the tests pass. This generally has the effect of improving the quality of individual commits without needing to rely too much on server side checks for code quality.</p>
<p>As an alternative to running pre-commit hooks, one can still run the checks manually but the programmer must be careful that all checks pass. If everything is setup correctly, the CI should not permit a commit to <code class="docutils literal notranslate"><span class="pre">master</span></code> unless all tests are successful. To see up-to-date commands, consult the relevant workflow. Note that different versions of python (+packages) may give different errors to the CI, so correcting errors may take a few attempts. There may also be discrepancies between the client pre-commit hooks and server CI checks. It is best to update the pre-commit hooks if possible in this case.</p>
<div class="admonition-todo admonition" id="id6">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Prevent commits unless all tests pass.</p></li>
<li><p>Convert setup.cfg to pyproject.toml (if using black - does not support setup.cfg)</p></li>
<li><p>Consider using style-guide instead of black (i.e. autopep8) - black ensures consistency at the detriment of readability.</p></li>
<li><p>Add dev-requirements file. <code class="docutils literal notranslate"><span class="pre">flake8</span></code>, <code class="docutils literal notranslate"><span class="pre">flake8-docstrings</span></code>, <code class="docutils literal notranslate"><span class="pre">mypy</span></code>, <code class="docutils literal notranslate"><span class="pre">black</span></code>, <code class="docutils literal notranslate"><span class="pre">isort</span></code>.</p></li>
<li><p>Function arguments on individual lines may be preferred to make diffs slightly clearer. But I recommend writing a comprehensive style-guide (by extending the above) rather than using a strict autoformatter like black.</p></li>
</ul>
</div>
</section>
</section>
<section id="linting">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">5.2.3. </span>Linting</a><a class="headerlink" href="#linting" title="Link to this heading"></a></h3>
<p>Flake8 includes linting, syntax errors, and McCabe function complexity analysis.</p>
<p>The are several instances where Flake8 errors have been purposely ignored in Detectree2 using <code class="docutils literal notranslate"><span class="pre">noqa:</span> <span class="pre">&lt;CODE&gt;</span></code> annotations to allow flake8 CI to pass. This is not a permanent fix and the errors should eventually be addressed. For example: <code class="docutils literal notranslate"><span class="pre">noqa:</span> <span class="pre">E501</span></code> ensures that line lengths beyond (120 characters) are ignored by the linter and <code class="docutils literal notranslate"><span class="pre">noqa:</span> <span class="pre">901</span></code> ignores the McCabe complexity measure.</p>
<p>These can also be set globally in setup.cfg, but fewer the better. It is also possible to set <code class="docutils literal notranslate"><span class="pre">continue-on-error</span></code> in the flake8 workflow or <code class="docutils literal notranslate"><span class="pre">--exit-zero</span></code> flake8 argument to allow other checks to continue. In practice it was found that developers tend to ignore flake8 errors as a result of these two options, so the <code class="docutils literal notranslate"><span class="pre">noqa</span></code> solution is preferred.</p>
<p>McCabe function complexity analysis is useful for detecting over-complex code (as determined by the amount of branching - <cite>if</cite>, <cite>else</cite> statements). A value of 10 is set as default. This is perhaps overkill and may be removed.</p>
</section>
<section id="docstrings">
<h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">5.2.4. </span>Docstrings</a><a class="headerlink" href="#docstrings" title="Link to this heading"></a></h3>
<p>We adopt google docstrings (<a class="reference external" href="https://google.github.io/styleguide/pyguide.html">https://google.github.io/styleguide/pyguide.html</a>)</p>
<p>Other dependencies include <code class="docutils literal notranslate"><span class="pre">flake8-docstrings</span></code>,</p>
<div class="admonition-todo admonition" id="id7">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">pydocstyle</span></code></p></li>
</ul>
</div>
</section>
<section id="autoformatters">
<h3><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">5.2.5. </span>Autoformatters</a><a class="headerlink" href="#autoformatters" title="Link to this heading"></a></h3>
<p>We adopt <code class="docutils literal notranslate"><span class="pre">yapf</span></code> for this project, but others are listed for completion.</p>
<section id="yapf">
<h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">5.2.5.1. </span>YAPF</a><a class="headerlink" href="#yapf" title="Link to this heading"></a></h4>
<p>From the <a class="reference external" href="https://github.com/google/yapf">YAPF docs</a>:</p>
<blockquote>
<div><p>Most of the current formatters for Python — e.g., autopep8, and pep8ify — are made to remove lint errors from code. This has some obvious limitations. For instance, code that conforms to the PEP 8 guidelines may not be reformatted. But it doesn’t mean that the code looks good.</p>
</div></blockquote>
<p>YAPF is highly customisable and shares a similar philosophy to <code class="docutils literal notranslate"><span class="pre">black</span></code>. It is possible to customise behaviour of any autoformatter like <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> or <code class="docutils literal notranslate"><span class="pre">black</span></code> with  project modifications.</p>
</section>
<section id="black">
<h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">5.2.5.2. </span>Black</a><a class="headerlink" href="#black" title="Link to this heading"></a></h4>
<p>From the <a class="reference external" href="https://black.readthedocs.io/en/stable/">Black docs</a>:</p>
<blockquote>
<div><p>Black is the uncompromising Python code formatter. By using it, you agree to cede control over minutiae of hand-formatting. In return, Black gives you speed, determinism, and freedom from pycodestyle nagging about formatting. You will save time and mental energy for more important matters.</p>
</div></blockquote>
<p>It favours consistency, meaning it is guaranteed to give the same results across the team - a style guide is not needed.</p>
</section>
<section id="autopep8">
<h4><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">5.2.5.3. </span>Autopep8</a><a class="headerlink" href="#autopep8" title="Link to this heading"></a></h4>
<p>Autopep8 is an autoformatter (like Black) with enforces the <code class="docutils literal notranslate"><span class="pre">PEP8</span></code> style guide. Autopep8 is a loose formatter, which will fix PEP8 errors but will not make the code uniform. It relies a little more on the programmer, whereas <code class="docutils literal notranslate"><span class="pre">black</span></code>, which also produces PEP8 compatible code, is more opinionated in its approach.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">autopep8</span> <span class="c1"># if not already installed</span>
<span class="n">autopep8</span> <span class="o">--</span><span class="ow">in</span><span class="o">-</span><span class="n">place</span> <span class="o">--</span><span class="n">aggressive</span> <span class="o">--</span><span class="n">aggressive</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>It is possible to configure vscode to autoformat with <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> on save if desired.</p>
<div class="admonition-todo admonition" id="id8">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Consider configuring YAPF with pep8 settings to create unformity for project contributors.</p></li>
</ul>
</div>
</section>
<section id="formatting-aside">
<h4><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">5.2.5.4. </span>Formatting aside</a><a class="headerlink" href="#formatting-aside" title="Link to this heading"></a></h4>
<p>The difference between the strict autoformatter <code class="docutils literal notranslate"><span class="pre">yapf</span></code> and the official demonstrated for function arguments with the example below. Both examples are PEP8 compliant and will pass <code class="docutils literal notranslate"><span class="pre">flake8</span></code> linting checks. The former is better for diffs and typing clarity, whereas the latter has fewer lines.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># black or yapf:</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tile_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">DatasetReader</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">tile_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">tile_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">dtype_bool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>


<span class="c1"># Python&#39;s official `style`</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tile_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">DatasetReader</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
              <span class="n">dtype_bool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</pre></div>
</div>
</section>
</section>
<section id="static-typing">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">5.2.6. </span>Static typing</a><a class="headerlink" href="#static-typing" title="Link to this heading"></a></h3>
<p>From the <a class="reference external" href="http://mypy-lang.org/">Mypy docs</a>:</p>
<blockquote>
<div><p>Mypy is an optional static type checker for Python that aims to combine the benefits of dynamic (or ‘duck’) typing and static typing. Mypy combines the expressive power and convenience of Python with a powerful type system and compile-time type checking.</p>
</div></blockquote>
<p>The general idea is to add typing to functions that are most frequently used. It is not necessary to apply across the entire codebase.</p>
<p>The <cite>mypy</cite> syntax adopted in Detectree2 supports python3.7 and above, but could be updated as the project moves towards more modern python3 (I see no reason not to adopt python 3.10). <cite>mypy</cite> will attempt to type check all third-party libraries - which might not be desirable. It is possible to install stubs for third-party libraries (i.e. <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, <code class="docutils literal notranslate"><span class="pre">openCV</span></code>) if type-checking is desired, but it is easier to suppress all missing import errors libraries by adding  <code class="docutils literal notranslate"><span class="pre">ignore_missing_imports</span> <span class="pre">=</span> <span class="pre">True</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code>.</p>
</section>
</section>
<section id="continuous-integration">
<h2><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">5.3. </span>Continuous integration</a><a class="headerlink" href="#continuous-integration" title="Link to this heading"></a></h2>
<p>The idea of Continuous integration (CI) is to frequently commit code to a shared repo. This has the effect of detecting errors sooner thereby reducing the amount of code a developer needs to debug when finding an error. Frequent updates also make it easier to merge changes from different members of the software development team. This is especially powerful when paired automated code building and testing. Testing can include code linters, as well as unit and integration tests.</p>
<p>Building and testing code requires a server. CI using GitHub actions offers workflows that can build the repository code and run tests. We can run on GitHub’s own virtual machines (using GitHub-hosted runners), or on machines that we host ourselves (or on compute clusters). The latter is desirable as GitHub does not currently support access to GPU resources.</p>
<p>Currently there are three files that steer workflows. The schedule is set at the top of the file. The workflows are found <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/master/.github/workflows">here</a></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">python-app.yml</span></code>: All style CI - builds the code on Ubuntu-20.04</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dockertest.yml</span></code>: All style CI - uses docker image for dependencies and installs detectree2 using pip.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">documentation.yml</span></code>: Generates documentation and hosts on github pages. Builds code first for sphinx-apidoc.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">dockertest.yml</span></code> workflow is an attempt to utilise docker to speed up deployment and testing of detectree2. It pulls the docker image: <a class="reference external" href="https://hub.docker.com/repository/docker/ma595/detectree-cpu-20.04">ma595/detectree-cpu-20.04:latest</a> (Python3.8) and installs detectree2 on top. A more up to date docker container, utilising python3.10 and ubuntu 22.04 has been successfully built but has yet to be integrated into the workflow, the file can be found in <a class="reference external" href="https://github.com/ma595/detectree2-docker/blob/main/files/Dockerfile-22.04">github:ma595/detectree2-docker/Dockerfile-22.04</a>.</p>
<p>All dockerfiles are in <a class="reference external" href="https://github.com/ma595/detectree2-docker">github:ma595/detectree2-docker</a>, which uses <a class="reference external" href="https://github.com/ma595/detectree2-data">github:ma595/detectree2-data</a> to store the data required for the workflow.</p>
<div class="admonition-todo admonition" id="id10">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Harmonise sphinx.yml and python-app.yml into single file where appropriate. There is no good reason to separate.</p></li>
<li><p>Add GPU testing to workflow (currently unsupported on Github, but we can use CSD3’s A100 resources).</p></li>
<li><p>Prevent merge unless all tests are passing</p></li>
<li><p>Build docker image as part of an action and push to dockerhub (or use github’s docker features)</p></li>
<li><p>Check 22.04 docker image</p></li>
<li><p>Move dockerfiles into detectree2 project.</p></li>
<li><p>Style check documentation.</p></li>
</ul>
</div>
</section>
<section id="automatic-documentation">
<h2><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">5.4. </span>Automatic Documentation</a><a class="headerlink" href="#automatic-documentation" title="Link to this heading"></a></h2>
<p>Documentation is generated automatically using Sphinx and GitHub actions in <a class="reference external" href="https://github.com/PatBall1/detectree2/blob/master/.github/workflows/documentation.yaml">documentation.yaml</a>.</p>
<p>Documentation can be generated locally to test rendering. It is better to develop locally rather than rely on the CI and hosted docs as a check, as it can take quite some time to build using the workflow.</p>
<p>To generate locally it is necessary to install the following dependencies (either in pip or conda):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">sphinx</span> <span class="n">sphinx_rtd_theme</span>
</pre></div>
</div>
<p>Then generate api documentation, and build the html.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sphinx</span><span class="o">-</span><span class="n">apidoc</span> <span class="o">-</span><span class="n">o</span> <span class="o">./</span><span class="n">docs</span><span class="o">/</span><span class="n">source</span><span class="o">/</span> <span class="n">detectree2</span><span class="o">/</span>
<span class="n">sphinx</span><span class="o">-</span><span class="n">build</span> <span class="o">-</span><span class="n">b</span> <span class="n">html</span> <span class="n">docs</span><span class="o">/</span><span class="n">source</span><span class="o">/</span> <span class="n">docs</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">html</span>
</pre></div>
</div>
<p>Then using your favourite browser open docs/build/html/index.html. It’s often necessary to delete the build output to remove old html.</p>
<div class="admonition-todo admonition" id="id11">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Style checks on documentation.</p></li>
</ul>
</div>
</section>
<section id="tests">
<h2><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">5.5. </span>Tests</a><a class="headerlink" href="#tests" title="Link to this heading"></a></h2>
<p>Test-driven development stipulates that tests should be written as new features are introduced to the code. To run the tests simply do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># install Pytest if haven&#39;t already done so.</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">pytest</span>
<span class="c1"># pytest should be run from the project root:</span>
<span class="n">pytest</span> <span class="o">.</span>
</pre></div>
</div>
<p>It can sometimes be helpful to run individual tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">-</span><span class="n">rP</span> <span class="o">-</span><span class="n">v</span> <span class="n">detectree2</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_preprocessing</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">k</span> <span class="n">test_to_traintest_folders</span>
</pre></div>
</div>
<p>Which runs the <em>test_to_traintest_folders</em> function in the test_preprocessing.py module, and captures whatever output that may be produced.</p>
<p>A few unit tests have been implemented but there is definitely scope to add more. <em>test_preprocessing.py</em> executes a few functions like tile_data_train, and to_traintest_folders, but does not test if the output is correct. <code class="docutils literal notranslate"><span class="pre">pytest.mark.order</span></code> is used to force dependencies but better approaches may exist. Further TODOs are listed within the code.</p>
<p><em>test_prediction.py</em> executes some quite trivial tests. <em>test_evaluation.py</em> computes the area intersection over union (with dummy .geojson data containing square shapes with known areas). The test is still incomplete as some of the code in evaluation.py needs refactoring slightly.</p>
<p>As of August 2022, an integration test has been written which demos the tiling, and training steps. The integration test will run the training on the CPU only. It is possible to run tests on other systems using GitHub, but this will take more work.</p>
<p>TIP: Always write tests for newly introduced logic when contributing code.</p>
<div class="admonition-todo admonition" id="id12">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Write more unit tests for existing code.</p></li>
</ul>
</div>
</section>
<section id="building-detectree2">
<h2><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">5.6. </span>Building Detectree2</a><a class="headerlink" href="#building-detectree2" title="Link to this heading"></a></h2>
<section id="gdal-complexities">
<h3><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">5.6.1. </span>GDAL complexities</a><a class="headerlink" href="#gdal-complexities" title="Link to this heading"></a></h3>
<p>GDAL presents a number of complexities. The issue is covered in <a class="reference external" href="https://github.com/PatBall1/detectree2/issues/1">gdal/issue</a> We must point to the location of the preinstalled GDAL headers, and the GDAL version must match the pip package version. <a class="reference external" href="https://github.com/OSGeo/gdal/issues/2293">https://github.com/OSGeo/gdal/issues/2293</a>
For instance, on my cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gdal</span><span class="o">-</span><span class="n">config</span> <span class="o">-</span><span class="n">v</span>  <span class="c1"># gives 3.0.4</span>
</pre></div>
</div>
<p>So this means we must install the corresponding pip version: <code class="docutils literal notranslate"><span class="pre">GDAL==3.0.4</span></code>.</p>
<p>In the event that GDAL does not exist on the system, install it as so (assuming root access):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">libgdal</span><span class="o">-</span><span class="n">dev</span> <span class="n">gdal</span><span class="o">-</span><span class="nb">bin</span>
</pre></div>
</div>
</section>
<section id="using-pip">
<h3><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">5.6.2. </span>Using pip</a><a class="headerlink" href="#using-pip" title="Link to this heading"></a></h3>
<p>It is relatively straightforward to install detectree2 on Colab. Simply pip install and all dependencies will be installed automatically.</p>
<p>On other systems the process is more involved especially if root access is not available. See workflow <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/master/.github/workflows/python-app.yml">python-app.yaml</a> workflow for a working CPU deployment.</p>
<p>First we need to install <code class="docutils literal notranslate"><span class="pre">pytorch</span></code>, <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> and <code class="docutils literal notranslate"><span class="pre">torchaudio</span></code> (compatible versions <a class="reference external" href="https://pypi.org/project/torchvision/">https://pypi.org/project/torchvision/</a>).</p>
<p>This can be done inside <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> (if root access is unavailable):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="o">./</span><span class="n">venv</span> <span class="c1"># (check version of python is sufficiently high &gt;=3.7)</span>
<span class="o">.</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">pip</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">wheel</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">opencv</span><span class="o">-</span><span class="n">python</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.11.0</span><span class="o">+</span><span class="n">cu113</span> <span class="n">torchvision</span><span class="o">==</span><span class="mf">0.12.0</span><span class="o">+</span><span class="n">cu113</span> <span class="n">torchaudio</span><span class="o">==</span><span class="mf">0.11.0</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">cu113</span>
</pre></div>
</div>
<p>Then point to preinstalled GDAL header files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CPLUS_INCLUDE_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">gdal</span>
<span class="n">export</span> <span class="n">C_INCLUDE_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">gdal</span>
</pre></div>
</div>
<p>then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>  <span class="c1"># (add -e flag to allow editable installs)</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="id14">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Pin torch and torchvision versions in setup.py</p></li>
<li><p><a class="reference external" href="https://detectron2.readthedocs.io/en/latest/tutorials/install.html">https://detectron2.readthedocs.io/en/latest/tutorials/install.html</a></p></li>
<li><p><a class="reference external" href="http://www.tekroi.in/detectron2/projects/DensePose/setup.py">http://www.tekroi.in/detectron2/projects/DensePose/setup.py</a></p></li>
<li><p><a class="reference external" href="https://stackoverflow.com/questions/66738473/installing-pytorch-with-cuda-in-setup-py">https://stackoverflow.com/questions/66738473/installing-pytorch-with-cuda-in-setup-py</a></p></li>
</ul>
</div>
<section id="fixing-detectron2-version">
<h4><a class="toc-backref" href="#id47" role="doc-backlink"><span class="section-number">5.6.2.1. </span>Fixing detectron2 version</a><a class="headerlink" href="#fixing-detectron2-version" title="Link to this heading"></a></h4>
<p>We can fix the version of <code class="docutils literal notranslate"><span class="pre">detectron2</span></code> by pointing to the pre-built wheel using pip:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">detectron2</span><span class="o">==</span><span class="mf">0.6</span> <span class="o">-</span><span class="n">f</span> \ <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">dl</span><span class="o">.</span><span class="n">fbaipublicfiles</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">detectron2</span><span class="o">/</span><span class="n">wheels</span><span class="o">/</span><span class="n">cu113</span><span class="o">/</span><span class="n">torch1</span><span class="mf">.10</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>Or by changing the <code class="docutils literal notranslate"><span class="pre">detectron2</span></code> line in setup.py (which will build the latest version from source):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detectron2</span><span class="nd">@https</span><span class="p">:</span><span class="o">//</span><span class="n">dl</span><span class="o">.</span><span class="n">fbaipublicfiles</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">detectron2</span><span class="o">/</span><span class="n">wheels</span><span class="o">/</span><span class="n">cu113</span><span class="o">/</span><span class="n">torch1</span><span class="mf">.10</span><span class="o">/</span><span class="n">detectron2</span><span class="o">-</span><span class="mf">0.6</span><span class="o">%</span><span class="mi">2</span><span class="n">Bcu113</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">linux_x86_64</span><span class="o">.</span><span class="n">whl</span>
</pre></div>
</div>
<p>It may be preferable to do this as errors have a tendency to be introduced into the <code class="docutils literal notranslate"><span class="pre">detectron2</span></code> codebase and may take a day or two to fix.
We can also point to a specific working commit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">facebookresearch</span><span class="o">/</span><span class="n">detectron2</span><span class="o">.</span><span class="n">git</span><span class="o">@</span><span class="mi">5</span><span class="n">aeb252b194b93dc2879b4ac34bc51a31b5aee13</span>

<span class="c1"># or within setup.py (not tested):</span>
<span class="n">detectron2</span><span class="nd">@git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">facebookresearch</span><span class="o">/</span><span class="n">detectron2</span><span class="o">.</span><span class="n">git</span><span class="o">@</span><span class="mi">5</span><span class="n">aeb252b194b93dc2879b4ac34bc51a31b5aee13</span>
</pre></div>
</div>
</section>
</section>
<section id="building-detectree2-using-conda">
<h3><a class="toc-backref" href="#id48" role="doc-backlink"><span class="section-number">5.6.3. </span>Building Detectree2 using Conda</a><a class="headerlink" href="#building-detectree2-using-conda" title="Link to this heading"></a></h3>
<p>Many of the aforementioned complexities can be solved using Conda. This is currently working for python 3.9.13, in branch <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/matt/conda">matt/conda</a>. The most important file is <a class="reference external" href="https://github.com/PatBall1/detectree2/blob/matt/conda/conda/environment.yaml">environment.yaml</a> which specifies the required dependencies.</p>
<p>Install miniconda, and source (usually <code class="docutils literal notranslate"><span class="pre">~/.miniconda/bin/activate</span></code> if not in <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> already). Begin by installing <code class="docutils literal notranslate"><span class="pre">mamba</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="n">mamba</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span>
<span class="n">mamba</span> <span class="n">env</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">envrironment</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">mamba</span> <span class="n">activate</span> <span class="n">detectree2env</span>
</pre></div>
</div>
<p>Alternatively we may use a conda lock file which has transitive dependencies pinned. This improves reproducibility.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mamba</span> <span class="n">create</span> <span class="o">--</span><span class="n">name</span> <span class="n">detectree2env</span> <span class="o">--</span><span class="n">file</span> <span class="n">conda</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="mf">64.</span><span class="n">lock</span>
</pre></div>
</div>
<p>and if we modify our environment, we can update the lock file as so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span><span class="o">-</span><span class="n">lock</span> <span class="o">-</span><span class="n">k</span> <span class="n">explicit</span> <span class="o">--</span><span class="n">conda</span> <span class="n">mamba</span>
</pre></div>
</div>
<p>and then update conda packages based on the regenerated lock file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mamba</span> <span class="n">update</span> <span class="o">--</span><span class="n">file</span> <span class="n">conda</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="mf">64.</span><span class="n">lock</span>
</pre></div>
</div>
<p>The downside of this approach is that it takes much longer to install compared to pip, even with Mamba’s improved dependency resolution.</p>
<div class="admonition-todo admonition" id="id15">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Determine how this can be integrated into current pip install without breaking <code class="docutils literal notranslate"><span class="pre">colab</span></code> pip deployment.</p></li>
<li><p>Investigate use of poetry as it is easier to package a distribution. But detectron2 is not PEP517 compliant.</p></li>
<li><p>It is possible to combine Conda and Poetry, where Conda is used for packages like GDAL / detectron2 / openCV.</p></li>
</ul>
</div>
</section>
<section id="distributing-detectree2-using-conda">
<h3><a class="toc-backref" href="#id49" role="doc-backlink"><span class="section-number">5.6.4. </span>Distributing detectree2 using Conda</a><a class="headerlink" href="#distributing-detectree2-using-conda" title="Link to this heading"></a></h3>
<p>In the <a class="reference external" href="https://github.com/PatBall1/detectree2/tree/matt/conda">matt/conda</a> branch, the <a class="reference external" href="https://github.com/PatBall1/detectree2/blob/matt/conda/conda/meta.yaml">conda/meta.yaml</a> packages detectree2. An initial attempt can be found here: <a class="reference external" href="https://anaconda.org/ma595/detectree2">ma595/detectree2</a>. To install, do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">ma595</span> <span class="n">detectree2</span>
</pre></div>
</div>
<p>To rebuild from meta.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span><span class="o">-</span><span class="n">build</span> <span class="o">.</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="o">-</span><span class="n">c</span> <span class="n">pytorch</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">folder</span> <span class="o">./</span><span class="n">conda</span><span class="o">-</span><span class="n">bld</span>
</pre></div>
</div>
<p>Then upload to anaconda:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anaconda</span> <span class="n">login</span>
<span class="n">anaconda</span> <span class="n">upload</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">tar</span><span class="o">.</span><span class="n">bz2</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="id17">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Automate distribution of package to <a class="reference external" href="https://anaconda.org/ma595/detectree2">anaconda</a> using workflow.</p></li>
</ul>
</div>
</section>
</section>
<section id="python-development-environment">
<h2><a class="toc-backref" href="#id50" role="doc-backlink"><span class="section-number">5.7. </span>Python development environment</a><a class="headerlink" href="#python-development-environment" title="Link to this heading"></a></h2>
<div class="admonition-todo admonition" id="id18">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>Setting up visual studio.</p></li>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">dev-environment.yaml</span></code> file.</p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cluster.html" class="btn btn-neutral float-left" title="4. Running in Jupyter Notebook on a HPC platform" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="using-git.html" class="btn btn-neutral float-right" title="6. Git/Github" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, James Ball.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>